<!DOCTYPE html>
<html>

<head>
    <title>World editor</title>
    <link rel="stylesheet" href="styles.css" />
</head>

<body>
    <h1> World editor</h1>
    <canvas id="myCanvas"></canvas>

    <div id="controls">
        <button onclick="dispose()">‚ùå</button>
        <button onclick="save()">üíæ</button>
        &nbsp;
        <button id='graphBtn' onclick="setMode('graph')">üõ£</button>
        <button id='stopBtn' onclick="setMode('stop')">‚õîÔ∏è</button>
        <button id='crossingBtn' onclick="setMode('crossing')">üü∞</button>



    </div>
    <script src="js/editors/GraphEditor.js"></script>
    <script src="js/editors/StopEditor.js"></script>
    <script src="js/editors/CrossingEditor.js"></script>
    <script src="js/markings/stop.js"></script>
    <script src="js/ViewPort.js"></script>
    <script src="js/World.js"></script>
    <script src="js/items/Tree.js"></script>
    <script src="js/items/Building.js"></script>
    <script src="js/math/graph.js"></script>
    <script src="js/math/utils.js"></script>
    <script src="js/primitives/polygon.js"></script>
    <script src="js/primitives/envelope.js"></script>
    <script src="js/primitives/point.js"></script>
    <script src="js/primitives/segments.js"></script>
    <script>

        myCanvas.width = 600;
        myCanvas.height = 600;

        const ctx = myCanvas.getContext('2d');
        const graphstring = localStorage.getItem("graph");
        const graphInfo = graphstring ? JSON.parse(graphstring) : null
        const graph = !graphInfo ? new Graph() : Graph.load(graphInfo);
        const world = new World(graph)
        const viewPort = new ViewPort(myCanvas)
        const graphEditor = new GraphEditor(viewPort, graph)
        const stopEditor = new StopEditor(viewPort, world)
        const crossingEditor = new CrossingEditor(viewPort, world)

        let oldGraphHash = graph.hash()
        disableEditors()
        setMode('graph')
        animate();

        function animate() {
            viewPort.reset()
            if (graph.hash() != oldGraphHash) {
                world.generate()
                oldGraphHash = graph.hash()
            }
            const viewPoint = scale(viewPort.getOffset(), -1)
            world.draw(ctx, viewPoint)
            ctx.globalAlpha = 0.3
            graphEditor.display()
            stopEditor.display()
            crossingEditor.display()
            requestAnimationFrame(animate);
        }

        function dispose() {
            graphEditor.dispose()
            world.markings.length = 0
        }
        function save() {
            localStorage.setItem("graph", JSON.stringify(graph));
        }
        function setMode(mode) {
            disableEditors()
            switch (mode) {
                case 'graph': {
                    graphBtn.style.backgroundColor = 'white'
                    graphBtn.style.filter = ''
                    graphEditor.enable()
                    break;
                }
                case 'stop': {
                    stopBtn.style.backgroundColor = 'white'
                    stopBtn.style.filter = ''
                    stopEditor.enable()
                    break;
                }
                case 'crossing': {
                    crossingBtn.style.backgroundColor = 'white'
                    crossingBtn.style.filter = ''
                    crossingEditor.enable()
                    break;
                }
            }
        }
        function disableEditors() {
            graphBtn.style.backgroundColor = 'gray'
            graphBtn.style.filter = 'grayscale(100%)'
            graphEditor.disable()
            stopBtn.style.backgroundColor = 'gray'
            stopBtn.style.filter = 'grayscale(100%)'
            stopEditor.disable()

        }


    </script>

</body>

</html>